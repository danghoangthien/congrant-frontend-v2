ArticleEditor.iconMath='<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m11 2c.5522847 0 1 .44771525 1 1 0 .51283584-.3860402.93550716-.8833789.99327227l-.1166211.00672773h-3.92l2.70086881 3.37530495c.26561359.33201696.28976029.79108692.07244006 1.14620443l-.07244006.10318567-2.70186881 3.37530495h3.921c.5128358 0 .9355072.3860402.9932723.8833789l.0067277.1166211c0 .5128358-.3860402.9355072-.8833789.9932723l-.1166211.0067277h-6c-.80039229 0-1.26153081-.8837601-.84621928-1.5335763l.06535047-.0911187 3.49986881-4.375305-3.49986881-4.37530495c-.5000011-.62500138-.09797137-1.53717061.66889291-1.61880377l.1119759-.00589128z"/></svg>',ArticleEditor.add("block","block.math",{mixins:["block"],type:"math",inline:!0,editable:!1,control:!1,toolbar:{add:{command:"addbar.popup",title:"## buttons.add ##"},tags:{command:"math.edit",title:"## math.math ##",icon:ArticleEditor.iconMath}},create:function(){return this.dom("<span>").addClass("math")}}),ArticleEditor.add("plugin","math",{translations:{en:{math:{math:"Math",label:"Type an expression",add:"Add",save:"Save",cancel:"Cancel"},blocks:{math:"Math"}}},defaults:{classname:"math",mathjax:!1,delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]},popups:{add:{title:"## math.math ##",width:"100%",form:{text:{label:"## math.label ##",type:"textarea",rows:6}},footer:{insert:{title:"## math.add ##",command:"math.insert",type:"primary"},cancel:{title:"## math.cancel ##",command:"popup.close"}}},edit:{title:"## math.math ##",width:"100%",form:{text:{label:"## math.label ##",type:"textarea",rows:6}},footer:{save:{title:"## math.save ##",command:"math.save",type:"primary"},cancel:{title:"## math.cancel ##",command:"popup.close"}}}},subscribe:{"editor.parse":function(t){this._parse(t)},"editor.unparse, editor.before.cut, editor.before.copy":function(t){this._unparse(t)},"editor.ready, source.close, state.undo, state.redo, editor.paste":function(){this._render()}},start:function(){this.app.addbar.add("math",{title:"## blocks.math ##",icon:ArticleEditor.iconMath,command:"math.popup"})},popup:function(){this.app.popup.add("math",this.popups.add).open({focus:"text"})},edit:function(t,e){var a=this.app.popup.create("math",this.popups.edit),i=this.app.block.get().getBlock(),s=decodeURI(i.attr("data-math-code"));s=this._decodeSigns(s),a.setData({text:s}),this.app.popup.open({button:e,focus:"text"})},save:function(t){this.app.popup.close();var e=this.app.block.get().getBlock(),a=this._buildBlock(e,t);!1!==a&&(this._renderDisplay(e),this._renderTypeset(e,a))},insert:function(t){this.app.popup.close();var e=this.app.create("block.math"),a=e.getBlock(),i=this._buildBlock(a,t);!1!==i&&(this.app.block.add({instance:e}),this._renderDisplay(a),this._renderTypeset(a,i))},_buildBlock:function(t,e){var a=e.getData().text.trim(),i=this._parseDelim(a);return!!i&&(t.attr("data-math-display",i.display),t.attr("data-math-code",encodeURI(a)),this.opts.math.mathjax||(a=a.replace(i.left,"").replace(i.right,"")),t.html(a),a)},_renderTypeset:function(t,e){this.opts.math.mathjax?this._getMathJax().typeset():this._renderNode(t,e)},_renderDisplay:function(t){var e={display:"inline-block","text-align":""};t.attr("data-math-display")?(e={display:"block","text-align":"center"},t.addClass("math-display")):t.removeClass("math-display"),t.css(e)},_renderNode:function(t,e){this._getKatex().render(e,t.get(),{displayMode:t.attr("data-math-display")})},_render:function(){this.opts.math.mathjax&&this._getMathJax().typeset(),this.app.editor.getBody().find("."+this.opts.math.classname).each(function(t){if(this._renderDisplay(t),!this.opts.math.mathjax){if(t.attr("data-math-render"))return;this._renderNode(t,t.text()),t.attr("data-math-render",!0)}}.bind(this))},_parseDelim:function(t){for(var e=this.opts.math.delimiters,a=0;a<e.length;a++){var i=new RegExp("^"+this.app.utils.escapeRegExp(e[a].left));if(-1!==t.search(i))return e[a]}},_getMathJax:function(){return this.app.editor.getWinNode().MathJax},_getKatex:function(){return this.app.editor.getWinNode().katex},_getReplacer:function(t,e,a){return"<span class="+this.opts.math.classname+" data-"+this.prefix+'-type="math" data-math-code="'+e+'" data-math-display="'+a+'">'+t+"</span>"},_encodeSigns:function(t){return t=(t=t.replace(/\$\$/g,"xdoubledollarsignz")).replace(/\$/g,"xsingledollarsignz")},_decodeSigns:function(t){return t=(t=t.replace(/xdoubledollarsignz/g,"$$$")).replace(/xsingledollarsignz/g,"$")},_parse:function(t){for(var e=t.get("html"),a=this.opts.math.delimiters,i=0;i<a.length;i++){var s=a[i].display?"([\\w\\W]*?)":"(.*?)",r=new RegExp(this.app.utils.escapeRegExp(a[i].left)+s+this.app.utils.escapeRegExp(a[i].right),"g"),p=e.match(r);if(null!=p)for(var n=0;n<p.length;n++){var o=p[n].trim(),h=this._encodeSigns(o);h=encodeURI(h),this.opts.math.mathjax||(o=o.replace(a[i].left,"").replace(a[i].right,"")),e=e.replace(p[n],this._getReplacer(o,h,a[i].display))}}t.set("html",e)},_unparse:function(t){var e=t.get("html");e=(e=this.app.utils.wrap(e,function(t){t.find("."+this.opts.math.classname).each(function(t){var e=decodeURI(t.attr("data-math-code"));e=(e=this._decodeSigns(e)).replace(/&/g,"xampsignmathz"),t.text(e),t.unwrap()}.bind(this))}.bind(this))).replace(/xampsignmathz/g,"&"),t.set("html",e)},_copy:function(t){var e=t.get("html");t.set("html",e)}});